!function(){"use strict";!function(){function t(t){this.value=t}function a(a){function e(n,o){try{var s=a[n](o),r=s.value;r instanceof t?Promise.resolve(r.value).then(function(t){e("next",t)},function(t){e("throw",t)}):i(s.done?"return":"normal",s.value)}catch(t){i("throw",t)}}function i(t,a){switch(t){case"return":n.resolve({value:a,done:!0});break;case"throw":n.reject(a);break;default:n.resolve({value:a,done:!1})}(n=n.next)?e(n.key,n.arg):o=null}var n,o;this._invoke=function(t,a){return new Promise(function(i,s){var r={key:t,arg:a,resolve:i,reject:s,next:null};o?o=o.next=r:(n=o=r,e(t,a))})},"function"!=typeof a.return&&(this.return=void 0)}"function"==typeof Symbol&&Symbol.asyncIterator&&(a.prototype[Symbol.asyncIterator]=function(){return this}),a.prototype.next=function(t){return this._invoke("next",t)},a.prototype.throw=function(t){return this._invoke("throw",t)},a.prototype.return=function(t){return this._invoke("return",t)}}();var t=function(t,a){if(!(t instanceof a))throw new TypeError("Cannot call a class as a function")},a=function(){function t(t,a){for(var e=0;e<a.length;e++){var i=a[e];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(a,e,i){return e&&t(a.prototype,e),i&&t(a,i),a}}();!function(e){var i=function(){function e(){t(this,e)}return a(e,null,[{key:"Android",value:function(){return navigator.userAgent.match(/Android/i)}},{key:"BlackBerry",value:function(){return navigator.userAgent.match(/BlackBerry/i)}},{key:"IOS",value:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)}},{key:"IPHONEIPOD",value:function(){return navigator.userAgent.match(/iPhone|iPod/i)}},{key:"Opera",value:function(){return navigator.userAgent.match(/Opera Mini/i)}},{key:"Windows",value:function(){return navigator.userAgent.match(/IEMobile/i)}},{key:"Any",value:function(){return this.Android()||this.BlackBerry()||this.IOS()||this.Opera()||this.Windows()}},{key:"exceptiPad",value:function(){return this.Android()||this.BlackBerry()||this.IPHONEIPOD()||this.Opera()||this.Windows()}}]),e}(),n=new(function(){function e(){t(this,e),this.blockID=null,this.name=null,this.prefix="wiloke_listgo_",this.aPageLoaded=[],this.period=86400,this.cachingMode="default",this.aPageCaching={},this.oText=WILOKE_LISTGO_TRANSLATION}return a(e,[{key:"notFound",value:function(){return _.template("<p><%- text %></p>")({text:this.oText.notfound})}},{key:"setPageLoaded",value:function(t){this.aPageLoaded.push(t.fullPath)}},{key:"getPageLoaded",value:function(t){return!!this.aPageLoaded.length&&-1!==this.aPageLoaded.indexOf(t.fullPath)}},{key:"setCaching",value:function(t,a,e){this.name=this.prefix+a,this.blockID=e,_.isUndefined(this.blockID)||this.generateBlockIDKey();var i=JSON.stringify(t);"default"===this.cachingMode?this.aPageCaching[this.name]=i:(localStorage.setItem(this.name,i),this.saveCreatedAt())}},{key:"getCaching",value:function(t,a,e){this.name=this.prefix+t,this.blockID=a,this.generateBlockIDKey();var i=this.getCreatedAt();if(e=parseInt(e,10),i=parseInt(i),!_.isNaN(e)&&!_.isNaN(i)&&e>i)return!1;if("default"===this.cachingMode)return void 0!==this.aPageCaching[this.name]&&JSON.parse(this.aPageCaching[this.name]);var n=localStorage.getItem(this.name);return JSON.parse(n)}},{key:"parseJSON",value:function(t){try{return JSON.parse(t)}catch(t){return WilokeDevMod,!1}}},{key:"generateBlockIDKey",value:function(){this.name=this.name+"_"+this.blockID}},{key:"saveCreatedAt",value:function(){var t=(new Date).getTime();localStorage.setItem(this.name+"_created_at",t)}},{key:"getCreatedAt",value:function(){return localStorage.getItem(this.name+"_created_at")}}]),e}()),o=function(){function o(a){t(this,o),this.$app=e("#"+a),this.mapInit()}return a(o,[{key:"mapIcon",value:function(t){var a=decodeURIComponent(WILOKE_GLOBAL.homeURI)+"img/icon-marker.png";return t.listing_cat_settings&&!_.isUndefined(t.listing_cat_settings.map_marker_image)&&""!==t.listing_cat_settings.map_marker_image&&(a=t.listing_cat_settings.map_marker_image),L.icon({iconUrl:a})}},{key:"panTo",value:function(t,a){var e=t;_.isArray(t)?this.instMap.panTo(t):(e=t.split(","),e=_.map(e,function(t){return parseFloat(t)}),this.instMap.panTo(e)),_.isUndefined(this.aLayers[e.join("-")])||void 0!==a||this.aLayers[e.join("-")].fire("click")}},{key:"parseCoordinate",value:function(t){if(""===t)return!1;var a=t.split(",");return a=_.map(a,function(t){return parseFloat(t)})}},{key:"setPopup",value:function(t,a,e){var i=this;this.aLayers[a.join("-")]=t,t.addEventListener("click",function(t){i.createPopup(e,a)})}},{key:"renderPopupContent",value:function(t){var a=this,e="";return _.isUndefined(t)||(e+='<div class="listing__content">',e+='<div class="address">',_.forEach(t,function(t,i){""===t||_.isUndefined(a.oText[i])||"website"===i||"email"===i||("phone_number"===i&&(t='<a href="tel:'+t+'">'+t+"</a>"),e+='<span class="address-'+i+'"><strong>'+a.oText[i]+":</strong> "+t+"</span>")}),e+="</div>",e+="</div>"),e}},{key:"getCenter",value:function(){return _.first(this.aListings).listing_settings.map.latlong}},{key:"setPopup",value:function(t,a,e){var i=this;this.aLayers[a.join("-")]=t,t.addEventListener("click",function(t){i.createPopup(e,a)})}},{key:"createPopup",value:function(t,a){var e=t.featured_image?t.featured_image.main.src:"",i=this.renderPopupContent(t.listing_settings),n=_.template('<div class="listing listing--grid">\n\t\t\t\t\t<div class="listing__media">\n\t\t\t\t\t\t<a href="<%- oItem.link %>" style="background-image: url(<%= featuredImage %>)"></a>\n\t\t\t\t\t\t<div class="listing__author">\n\t\t\t\t\t\t\t<a href="<%- oItem.author.link %>">\n\t\t\t\t\t\t\t<% if ( !_.isUndefined(oItem.author.user_first_character) ){ %>\n\t\t\t\t\t\t\t\t<span style="background-color: <%= oItem.author.avatar_color %>" class="widget_author__avatar-placeholder"><%- oItem.author.user_first_character %></span>\n\t\t\t\t\t\t\t<% }else{ %>\n\t\t\t\t\t\t\t\t<img src="<%- oItem.author.avatar %>" alt="<%- oItem.author.nickname %>">\n\t\t\t\t\t\t\t<% } %>\n\t\t\t\t\t\t\t</a>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="listing__body">\n\t\t\t\t\t\t<h3 class="listing__title"><a href="<%- oItem.link %>"><%- oItem.title %></a></h3>\n\t\t\t\t\t\t<div class="listgo__rating">\n\t\t\t\t\t\t\t<span class="rating__star">\n\t\t\t\t\t\t\t\t<% for (var i = 1; i <= 5; i++){ \n\t\t\t\t\t\t\t\t\tvar className = \'\';\n\t\t\t\t\t\t\t\t\tif (oItem.average_rating < i ){\n\t\t\t\t\t\t\t\t\t\tclassName = i == Math.floor(oItem.average_rating) ? \'fa fa-star-half-o\' : \'fa fa-star-o\';\n\t\t\t\t\t\t\t\t\t}else{\n\t\t\t\t\t\t\t\t\t\tclassName = \'fa fa-star\';\n\t\t\t\t\t\t\t\t\t}  %>\n\t\t\t\t\t\t\t\t\t<i class="<%- className %>"></i>\n\t\t\t\t\t\t\t\t<% } %>\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<%= address %>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>');L.popup({maxWidth:400,className:"wo-map-popup",closeButton:!1,offset:[14,-15]}).setLatLng(a).setContent(n({oItem:t,address:i,featuredImage:e})).openOn(this.instMap)}},{key:"addLayers",value:function(t){var a=this;_.forEach(t,function(t){if(a.aPostIDs.push(t.ID),t.listing_settings&&!_.isUndefined(t.listing_settings.map)){if(void 0===t.listing_settings.map||","===t.listing_settings.map.latlong||_.isNaN(t.listing_settings.map.latlong))return!1;var e=a.parseCoordinate(t.listing_settings.map.latlong);if(2===e.length){var i=L.marker(e,{icon:a.mapIcon(t)});a.aIDAndLatLng[t.ID]=e,a.oClusters.addLayer(i),a.instMap.addLayer(a.oClusters),a.setPopup(i,e,t),a.oMapLayers.push({instLayer:i,categories:t.listing_cat,listing_location_id:t.listing_location_id,listing_cat_id:t.listing_cat_id,title:t.title})}}}),this.$app.trigger("loadmore_map")}},{key:"getListOfListingAtTheFirstTime",value:function(){var t=this;this.$app.find(".wiloke-listgo-listing-item").each(function(){t.aListings.push(e(this).data("info"))}),this.$app.trigger("initMap")}},{key:"setUp",value:function(){var t=this;this.accessToken=WILOKE_GLOBAL.maptoken,this.instHelpers=n,this.aTemporaryCachingResults=[],this.cachingMylocation=null,this.instMyLocation=null,this.radiusInKM=5,this.circle=!1,this.$toggleSidebar=this.$app.find(".searchbox-hamburger"),this.$wilokeListingLayout=this.$app.find(".wiloke-listing-layout"),this.$searchForm=this.$app.find("#listgo-searchform"),this.$location=this.$app.find("#s_listing_location"),this.$submitSearchKeyWord=this.$app.find("#listgo-submit-searchkeyword"),this.$search=this.$app.find("#s_search"),this.$openNow=this.$app.find("#s_opennow"),this.$highestRated=this.$app.find("#s_highestrated"),this.$category=this.$searchForm.find("#s_listing_cat"),this.$location=this.$searchForm.find("#s_listing_location"),this.oData=this.$app.data("configs"),this.s_open_now=0,this.s_highest_rated=0,this.s_listing_location=this.$location.val(),this.s_listing_cat=this.$category.val(),this.s_listing_cat=""!==this.s_listing_cat?parseInt(this.s_listing_cat,10):"",this.aRawListings=[],this.aListings=[],this.oMapLayers=[],this.$app.on("initMap",function(){if(t.oDefault={center:t.getCenter(),maxClusterRadius:parseInt(WILOKE_GLOBAL.mapcluster,10),mapTheme:null,minZoom:null,maxZoom:null,centerZoom:null},t.aPostIDs=[],t.oText=WILOKE_LISTGO_TRANSLATION,t.oData=e.extend({},t.oDefault,t.oData),!_.isEmpty(t.aListings)){L.accessToken=t.accessToken,(_.isNull(t.oData.mapTheme)||""===t.oData.mapTheme)&&(t.oData.mapTheme=WILOKE_GLOBAL.maptheme),(_.isNull(t.oData.maxZoom)||""===t.oData.maxZoom)&&(t.oData.maxZoom=WILOKE_GLOBAL.mapmaxzoom),(_.isNull(t.oData.minZoom)||""===t.oData.minZoom)&&(t.oData.minZoom=WILOKE_GLOBAL.mapminzoom),(_.isNull(t.oData.centerZoom)||""===t.oData.centerZoom)&&(t.oData.centerZoom=WILOKE_GLOBAL.centerZoom);var a=t.parseCoordinate(t.oData.center),n=i.Any()?2:t.oData.centerZoom;t.$app.data("initialized",!0),t.instMap=L.mapbox.map(t.mapID,null,{minZoom:t.oData.minZoom,maxZoom:t.oData.maxZoom}).setZoom(n).setView(a),L.tileLayer(t.oData.mapTheme).addTo(t.instMap),t.oClusters=L.markerClusterGroup({animateAddingMarkers:!1,zoomToBoundsOnClick:!1,zoomToShowLayer:!0,showCoverageOnHover:!1,disableClusteringAtZoom:!1,spiderfyOnMaxZoom:!0,chunkedLoading:!0,maxClusterRadius:t.oData.maxClusterRadius,trackResize:!0,iconCreateFunction:function(t){return L.divIcon({html:"<b>"+t.getChildCount()+"</b>"})}}),t.addLayers(t.aListings)}}),this.getListOfListingAtTheFirstTime(),this.updateMap(),this.panToMarker(),this.closeMap()}},{key:"panToMarker",value:function(){var t=this;this.$wilokeListingLayout.on("click",".listgo_panto_marker",function(a){a.preventDefault(),t.$wilokeListingLayout.find(".listgo_panto_marker").addClass("active"),t.$map.addClass("active");var i=e(a.target).closest(".wiloke-listgo-listing-item").data("postid");_.isUndefined(t.aIDAndLatLng[i])||t.panTo(t.aIDAndLatLng[i])})}},{key:"closeMap",value:function(){var t=this;this.$map.on("click",".listgo-half-map__close",function(a){t.$map.removeClass("active")})}},{key:"updateMap",value:function(){var t=this;this.$wilokeListingLayout.on("ajax_completed",function(){if(!t.$wilokeListingLayout.find(".wil-alert").length){var a=t;t.$app.on("updateMap",function(a){t.oClusters.clearLayers(),t.instMap.closePopup(),t.addLayers(t.aListings);var e=t.parseCoordinate(t.getCenter());t.panTo(e,!0)}),t.aListings=[],t.$wilokeListingLayout.find(".wiloke-listgo-listing-item").each(function(){a.aListings.push(e(this).data("info"))}),t.$app.trigger("updateMap")}})}},{key:"getMylocationFromCaching",value:function(){var t=new Date;if(null===this.cachingMylocation){var a=localStorage.getItem("listgo_mylocation_created_at");t.getMinutes()-a<=5&&(this.cachingMylocation=e.parseJSON(localStorage.getItem("listgo_mylocation")))}}},{key:"getMyLocationController",value:function(){var t=this,a=decodeURIComponent(WILOKE_GLOBAL.homeURI)+"img/detect-mylocation.png";return new(L.Control.extend({options:{position:"topright"},onAdd:function(e){var n=L.DomUtil.create("div","leaflet-bar leaflet-control leaflet-control-detect-mylocation");return n.style.backgroundColor="white",n.style.backgroundImage="url("+a+")",n.style.backgroundSize="30px 30px",n.style.width="30px",n.style.height="30px",n.onclick=function(){i.Any()?(t.getMylocationFromCaching(),null===t.cachingMylocation?(t.instMap.on("locationfound",function(a){t.cachingMylocation=a.latlng,t.instMap.panTo(t.cachingMylocation)}),t.instMap.locate({setView:!0,maxZoom:t.oData.centerZoom,maximumAge:3e4,enableHighAccuracy:!0})):t.instMap.panTo(t.cachingMylocation)):(t.$app.addClass("list-map-wrap--setting-active"),t.$searchForm.find("#s_listing_location").val("mylocation").trigger("change"),t.s_listing_location="mylocation",t.s="",t.$showListing.trigger("click"))},n}}))}},{key:"mapInit",value:function(){if(!this.$app.length||this.$app.data("initialized"))return!1;this.mapID="listgo-half-map",this.$map=e("#"+this.mapID),this.xhr=null,this.oSearchCaching=[],this.reCheck=!1,this.currentDestination=[],this.aLayers=[],this.aIDAndLatLng=[],this.ggGeoCode=null,this.oTranslation=WILOKE_LISTGO_TRANSLATION,this.setUp()}},{key:"selected",value:function(t){return this.s_mapdirections===t}}]),o}();e(document).ready(function(){new o("listgo-half-map-wrap"),e(".listgo-half-map-wrap").each(function(){var t=e(this),a=t.offset(),i=t.outerHeight(),n=e(window).outerHeight();e(window).on("scroll",function(){var o=e(window).scrollTop();o>=a.top&&o+n<a.top+i?e(".listgo-half-map",t).addClass("fixed"):e(".listgo-half-map",t).removeClass("fixed"),o+n>=a.top+i?e(".listgo-half-map",t).addClass("abs"):e(".listgo-half-map",t).removeClass("abs")})})})}(jQuery)}();
